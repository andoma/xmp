/*
 * This program is  free software; you can redistribute it  and modify it
 * under the terms of the GNU  General Public License as published by the
 * Free Software Foundation; either version 2  of the license or (at your
 * option) any later version.
 *
 * Authors: Olivier Lapicque <olivierl@jps.net>
 */

/*
 * Modified for xmp 2.0 by Claudio Matsuoka
 * (optimized, removed all math functions, added precalculated tables)
 * Mon Dec 25 10:49:19 BRST 2000
 */

#include "xmp.h"
#include "common.h"
#include "player.h"
#include "virtual.h"
#include "mixer.h"

static const int filter_cutoff[] = {
     130,  132,  134,  136,  138,  140,  142,  144,
     146,  148,  151,  153,  155,  157,  160,  162,
     164,  167,  169,  172,  174,  177,  179,  182,
     184,  187,  190,  193,  195,  198,  201,  204,
     207,  210,  213,  216,  220,  223,  226,  229,
     233,  236,  239,  243,  246,  250,  254,  257,
     261,  265,  269,  273,  277,  281,  285,  289,
     293,  297,  302,  306,  311,  315,  320,  324,
     329,  334,  339,  344,  349,  354,  359,  364,
     369,  375,  380,  386,  391,  397,  403,  409,
     415,  421,  427,  433,  440,  446,  452,  459,
     466,  472,  479,  486,  493,  501,  508,  515,
     523,  530,  538,  546,  554,  562,  570,  578,
     587,  595,  604,  613,  622,  631,  640,  649,
     659,  668,  678,  688,  698,  708,  718,  729,
     739,  750,  761,  772,  783,  795,  806,  818,
     830,  842,  854,  867,  880,  892,  905,  918,
     932,  945,  959,  973,  987, 1002, 1016, 1031,
    1046, 1061, 1077, 1092, 1108, 1124, 1141, 1157,
    1174, 1191, 1209, 1226, 1244, 1262, 1280, 1299,
    1318, 1337, 1357, 1376, 1396, 1417, 1437, 1458,
    1479, 1501, 1523, 1545, 1567, 1590, 1613, 1637,
    1661, 1685, 1709, 1734, 1760, 1785, 1811, 1837,
    1864, 1891, 1919, 1947, 1975, 2004, 2033, 2062,
    2093, 2123, 2154, 2185, 2217, 2249, 2282, 2315,
    2349, 2383, 2418, 2453, 2489, 2525, 2561, 2599,
    2637, 2675, 2714, 2753, 2793, 2834, 2875, 2917,
    2959, 3003, 3046, 3091, 3135, 3181, 3227, 3274,
    3322, 3370, 3419, 3469, 3520, 3571, 3623, 3675,
    3729, 3783, 3838, 3894, 3951, 4008, 4066, 4125,
    4186, 4246, 4308, 4371, 4434, 4499, 4564, 4631,
    4698, 4766, 4836, 4906, 4978, 5050, 5123, 5198
};


static const float dmpfac[] = {
	1.0000000000, 0.9812888503, 0.9629278779, 0.9449104071,
	0.9272300601, 0.9098805189, 0.8928556442, 0.8761492968,
	0.8597555757, 0.8436685801, 0.8278825879, 0.8123919964,
	0.7971912026, 0.7822748423, 0.7676376104, 0.7532742620,
	0.7391796708, 0.7253487706, 0.7117766738, 0.6984585524,
	0.6853895783, 0.6725651622, 0.6599807143, 0.6476317644,
	0.6355138421, 0.6236226559, 0.6119539738, 0.6005036235,
	0.5892674923, 0.5782416463, 0.5674220920, 0.5568050146,
	0.5463865399, 0.5361630321, 0.5261308551, 0.5162863135,
	0.5066260099, 0.4971464872, 0.4878443182, 0.4787161946,
	0.4697588682, 0.4609691501, 0.4523439109, 0.4438800514,
	0.4355745614, 0.4274244606, 0.4194268584, 0.4115789235,
	0.4038778245, 0.3963208199, 0.3889051974, 0.3816283345,
	0.3744876385, 0.3674805760, 0.3606045842, 0.3538572788,
	0.3472362161, 0.3407390118, 0.3343634009, 0.3281070888,
	0.3219678402, 0.3159434497, 0.3100318015, 0.3042307496,
	0.2985382676, 0.2929522693, 0.2874708176, 0.2820919156,
	0.2768136561, 0.2716341615, 0.2665515840, 0.2615641057,
	0.2566699386, 0.2518673539, 0.2471546233, 0.2425300926,
	0.2379920781, 0.2335389853, 0.2291692048, 0.2248811871,
	0.2206734121, 0.2165443599, 0.2124925703, 0.2085165977,
	0.2046150118, 0.2007864416, 0.1970295012, 0.1933428496,
	0.1897251904, 0.1861752123, 0.1826916784, 0.1792733073,
	0.1759189069, 0.1726272553, 0.1693972051, 0.1662275940,
	0.1631172895, 0.1600651890, 0.1570701897, 0.1541312188,
	0.1512472481, 0.1484172493, 0.1456401944, 0.1429150999,
	0.1402409971, 0.1376169324, 0.1350419670, 0.1325151771,
	0.1300356686, 0.1276025623, 0.1252149642, 0.1228720546,
	0.1205729842, 0.1183169261, 0.1161030829, 0.1139306650,
	0.1117988899, 0.1097070053, 0.1076542661, 0.1056399345,
	0.1036632955, 0.1017236337, 0.0998202711, 0.0979525223,
	0.0961197242, 0.0943212137, 0.0925563574, 0.0908245221
};


/*
 * Simple 2-poles resonant filter
 */
void filter_setup(struct context_data *ctx, struct channel_data *xc, int cutoff)
{
	struct mixer_data *s = &ctx->s;
	/* [0-255] => [100Hz-8000Hz] */
	float fc = (float)filter_cutoff[cutoff];
	float fs = (float)s->freq;
	float fg, fb0, fb1;
	float d2, d, e;
	int res = xc->filter.resonance / 2;

	if (res > 127) {
		res = 127;
	}

	fc *= 3.14159265358979 * 2 / fs;
	d2 = dmpfac[res];
	d = (1.0 - d2) * fc;

	if (d > 2.0)
		d = 2.0;

	d = (d2 - d) / fc;
	e = 1.0 / (fc * fc);

	fg = 1.0 / (1 + d + e);
	fb0 = (d + e + e) / (1 + d + e);
	fb1 = -e / (1 + d + e);

	xc->filter.B0 = (int)(fg * FILTER_PRECISION);
	xc->filter.B1 = (int)(fb0 * FILTER_PRECISION);
	xc->filter.B2 = (int)(fb1 * FILTER_PRECISION);
}

